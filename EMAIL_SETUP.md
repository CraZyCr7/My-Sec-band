# 📧 SafeTrack Email Alert System Setup

## Overview
The SafeTrack system now includes a comprehensive email alert system that automatically sends critical safety alerts when PANIC or FALL events are detected.

## 🚀 How to Send Critical Alert Emails

### From the Control Center:

1. **Navigate to Control Panel**
   - Go to `/control-panel` in your dashboard
   - You'll see the "Email Notification Status" section

2. **Individual Alert Emails**
   - Each critical alert has a "Send Email" button
   - Click to send an email for that specific alert
   - The button disappears after email is sent

3. **Bulk Email Sending**
   - Use "Send All Pending Emails" to email multiple alerts at once
   - Shows count of pending emails
   - Automatically processes all unsent alerts

4. **Email System Verification**
   - Individual and bulk email sending available
   - Real-time email status tracking

### ⚠️ Important Note:
**Emails are now sent directly from your browser using EmailJS client library.** This resolves the "API calls disabled for non-browser applications" error that was occurring with the server-side approach.

## ⚙️ Email Configuration

### Current Setup (EmailJS):
- **Recipient**: as970789@gmail.com
- **Service ID**: service_9pp32yv
- **Service**: EmailJS
- **Format**: HTML + Plain Text
- **Content**: Auto-generated from device data

### Email Content Includes:
- 🚨 Critical alert status (PANIC/FALL)
- Device ID and location
- Heartbeat reading (BPM)
- GPS coordinates
- Timestamp
- Immediate action instructions

## 🔧 EmailJS Setup & Configuration

### ✅ What You Already Have:
- **Service ID**: `service_9pp32yv` ✅
- **EmailJS Account**: Set up and ready ✅

### 🔧 What You Need to Complete:

#### 1. **Get Your Public Key:**
- ✅ **Already Done!** Your Public Key: `B88SJXqcp_WB33ku_`
- This is used for authentication instead of User ID

#### 2. **Create Email Template:**
- In EmailJS Dashboard, go to "Email Templates"
- Click "Create New Template"
- Name it: `SafeTrack Alert Template`
- Use this template content:

```html
Subject: {{subject}}

🚨 CRITICAL SAFETY ALERT - SafeTrack System

Alert Details:
- Device ID: {{device_id}}
- Status: {{status}}
- Location: {{location}}
- Heartbeat: {{heartbeat}} BPM
- Coordinates: {{coordinates}}
- Timestamp: {{timestamp}}
- Priority: {{priority}}

{{html_content}}

IMMEDIATE ACTION REQUIRED
This is a critical safety alert requiring immediate attention.

Generated by SafeTrack Security System
```

#### 3. **Set Environment Variables:**
Create a `.env.local` file in your project root:
```bash
EMAIL_SERVICE_ID=service_9pp32yv
EMAIL_TEMPLATE_ID=your_template_id_here
EMAIL_PUBLIC_KEY=B88SJXqcp_WB33ku_
EMAIL_RECIPIENT=as970789@gmail.com
```

### 🚀 How EmailJS Works:
1. **Service ID**: Identifies your email service (Gmail, Outlook, etc.)
2. **Template ID**: Defines email format and content
3. **Public Key**: Authenticates your EmailJS account (already set!)
4. **Template Params**: Dynamic data inserted into emails

---

## 🔧 Alternative Email Integration Options
```bash
# Install SendGrid
npm install @sendgrid/mail

# Set environment variables
SENDGRID_API_KEY=your_api_key
EMAIL_FROM=noreply@safetrack.com
```

### Option 2: AWS SES
```bash
# Install AWS SDK
npm install @aws-sdk/client-ses

# Set environment variables
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
EMAIL_FROM=noreply@safetrack.com
```

### Option 3: Nodemailer (SMTP)
```bash
# Install Nodemailer
npm install nodemailer

# Set environment variables
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASS=your_app_password
```

## 📱 Email Templates

The system generates professional HTML emails with:
- **Header**: SafeTrack branding and alert type
- **Details Table**: All device and alert information
- **Action Section**: Clear instructions for responders
- **Footer**: System information and timestamp

## 🚨 Alert Types

### PANIC Alerts:
- High priority (red styling)
- Heartbeat typically >120 BPM
- Immediate response required

### FALL Alerts:
- Medium priority (orange styling)
- Heartbeat typically 90-120 BPM
- Quick response recommended

## 📊 Email Tracking

- **Status**: Shows sent/pending for each alert
- **History**: Tracks all email activity
- **Statistics**: Count of emails sent vs pending
- **Storage**: Email status saved in localStorage

## 🧪 Testing

1. **Individual Emails**: Send emails for specific critical alerts
2. **Bulk Emails**: Send multiple pending emails at once
3. **Verification**: Check email delivery and formatting
4. **Debugging**: Console logs show email sending progress

## 🔒 Security Features

- **Authentication**: Only authenticated users can send emails
- **Rate Limiting**: Built-in delays between bulk emails
- **Validation**: All alert data validated before sending
- **Error Handling**: Comprehensive error catching and user feedback

## 📈 Usage Statistics

The control panel shows:
- Total emails sent
- Pending emails count
- Email success/failure rates
- Recent email activity
- Storage usage statistics

## 🆘 Troubleshooting

### EmailJS Specific Issues:
1. **"Service not found"**: Verify your Service ID is correct
2. **"Template not found"**: Check Template ID in EmailJS dashboard
3. **"Public key invalid"**: Verify your Public Key is correct (already set!)
4. **"Rate limit exceeded"**: EmailJS has daily sending limits
5. **"Authentication failed"**: Check your EmailJS account status

### Common Issues:
1. **Email not sending**: Check API endpoint and network
2. **Wrong recipient**: Verify EMAIL_RECIPIENT in environment
3. **Format issues**: Check email template HTML
4. **Rate limits**: Add delays between bulk emails

### Debug Steps:
1. Check browser console for errors
2. Verify API route is accessible
3. Test with single email first
4. Check environment variables
5. Verify email service credentials

### EmailJS Debug Steps:
1. **Verify Service ID**: Check `service_9pp32yv` exists in your EmailJS dashboard
2. **Check Template ID**: Ensure template exists and is published
3. **Confirm Public Key**: Your Public Key `B88SJXqcp_WB33ku_` is already set ✅
4. **Test Template**: Use EmailJS dashboard to test template
5. **Check Quotas**: Verify you haven't exceeded daily email limits
6. **Service Status**: Check if your email service (Gmail/Outlook) is working

### 🔧 New Frontend Approach:
**Since emails are now sent directly from the browser:**
- ✅ **No more server-side API errors**
- ✅ **Direct EmailJS integration**
- ✅ **Better error handling and user feedback**
- ✅ **Real-time email status updates**

## 🎯 Best Practices

1. **Test First**: Always test email system before production
2. **Monitor**: Check email delivery rates regularly
3. **Backup**: Have fallback notification methods
4. **Document**: Keep email templates and configurations updated
5. **Security**: Use environment variables for sensitive data

## 📞 Support

For email system issues:
1. Check individual email sending functionality
2. Review console logs for errors
3. Verify EmailJS configuration
4. Check email service configuration
5. Review template setup

---

**SafeTrack Email System** - Keeping tourists safe with instant alert notifications! 🚨📧
